# Memory Keeper - Call Flow Diagrams

## ðŸ“ž Complete Call Sequence

### Sequence 1: Initial Load & Face Detection

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Browser â”‚    â”‚   page.tsx   â”‚    â”‚face-service â”‚    â”‚localStorage  â”‚
â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
     â”‚                â”‚                    â”‚                   â”‚
     â”‚ 1. Load Page   â”‚                    â”‚                   â”‚
     â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚                    â”‚                   â”‚
     â”‚                â”‚                    â”‚                   â”‚
     â”‚ 2. Load Photo  â”‚                    â”‚                   â”‚
     â”‚    /testphoto  â”‚                    â”‚                   â”‚
     â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤                    â”‚                   â”‚
     â”‚                â”‚                    â”‚                   â”‚
     â”‚ 3. Photo Loadedâ”‚                    â”‚                   â”‚
     â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚                    â”‚                   â”‚
     â”‚                â”‚                    â”‚                   â”‚
     â”‚                â”‚ 4. loadFaceModels()â”‚                   â”‚
     â”‚                â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚                   â”‚
     â”‚                â”‚                    â”‚                   â”‚
     â”‚                â”‚ 5. Load from       â”‚                   â”‚
     â”‚                â”‚    /public/models/ â”‚                   â”‚
     â”‚                â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤                   â”‚
     â”‚                â”‚                    â”‚                   â”‚
     â”‚                â”‚ 6. detectFaces()   â”‚                   â”‚
     â”‚                â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚                   â”‚
     â”‚                â”‚                    â”‚                   â”‚
     â”‚                â”‚ 7. faceapi.detect  â”‚                   â”‚
     â”‚                â”‚    AllFaces()      â”‚                   â”‚
     â”‚                â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤                   â”‚
     â”‚                â”‚                    â”‚                   â”‚
     â”‚                â”‚ 8. loadMemoryBank()â”‚                   â”‚
     â”‚                â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚
     â”‚                â”‚                    â”‚                   â”‚
     â”‚                â”‚ 9. Return MemoryBankâ”‚                   â”‚
     â”‚                â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
     â”‚                â”‚                    â”‚                   â”‚
     â”‚                â”‚ 10. matchFace()    â”‚                   â”‚
     â”‚                â”‚     for each face   â”‚                   â”‚
     â”‚                â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚                   â”‚
     â”‚                â”‚                    â”‚                   â”‚
     â”‚                â”‚ 11. Return matches â”‚                   â”‚
     â”‚                â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤                   â”‚
     â”‚                â”‚                    â”‚                   â”‚
     â”‚ 12. Display    â”‚                    â”‚                   â”‚
     â”‚     Face Boxes â”‚                    â”‚                   â”‚
     â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤                    â”‚                   â”‚
```

### Sequence 2: Starting Conversation

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Browser â”‚    â”‚   page.tsx   â”‚    â”‚/api/analyze-â”‚    â”‚  gemini.ts   â”‚    â”‚ Gemini API  â”‚
â”‚         â”‚    â”‚              â”‚    â”‚    photo    â”‚    â”‚              â”‚    â”‚             â”‚
â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
     â”‚                â”‚                    â”‚                   â”‚                   â”‚
     â”‚ 1. Click       â”‚                    â”‚                   â”‚                   â”‚
     â”‚    "Begin..."  â”‚                    â”‚                   â”‚                   â”‚
     â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚                    â”‚                   â”‚                   â”‚
     â”‚                â”‚                    â”‚                   â”‚                   â”‚
     â”‚                â”‚ 2. POST /api/      â”‚                   â”‚                   â”‚
     â”‚                â”‚    analyze-photo   â”‚                   â”‚                   â”‚
     â”‚                â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚                   â”‚                   â”‚
     â”‚                â”‚                    â”‚                   â”‚                   â”‚
     â”‚                â”‚                    â”‚ 3. analyzePhoto()  â”‚                   â”‚
     â”‚                â”‚                    â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚                   â”‚
     â”‚                â”‚                    â”‚                   â”‚                   â”‚
     â”‚                â”‚                    â”‚                   â”‚ 4. getGeminiClientâ”‚
     â”‚                â”‚                    â”‚                   â”‚    (API key)     â”‚
     â”‚                â”‚                    â”‚                   â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚
     â”‚                â”‚                    â”‚                   â”‚                   â”‚
     â”‚                â”‚                    â”‚                   â”‚ 5. generateContentâ”‚
     â”‚                â”‚                    â”‚                   â”‚    (Vision)       â”‚
     â”‚                â”‚                    â”‚                   â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
     â”‚                â”‚                    â”‚                   â”‚                   â”‚
     â”‚                â”‚                    â”‚ 6. Return         â”‚                   â”‚
     â”‚                â”‚                    â”‚    PhotoAnalysis  â”‚                   â”‚
     â”‚                â”‚                    â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤                   â”‚
     â”‚                â”‚                    â”‚                   â”‚                   â”‚
     â”‚                â”‚ 7. Response        â”‚                   â”‚                   â”‚
     â”‚                â”‚    { analysis }    â”‚                   â”‚                   â”‚
     â”‚                â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤                   â”‚                   â”‚
     â”‚                â”‚                    â”‚                   â”‚                   â”‚
     â”‚                â”‚ 8. POST /api/chat  â”‚                   â”‚                   â”‚
     â”‚                â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚                   â”‚                   â”‚
     â”‚                â”‚                    â”‚                   â”‚                   â”‚
     â”‚                â”‚                    â”‚ 9. buildConversationâ”‚                  â”‚
     â”‚                â”‚                    â”‚    Prompt()        â”‚                   â”‚
     â”‚                â”‚                    â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚                   â”‚
     â”‚                â”‚                    â”‚                   â”‚                   â”‚
     â”‚                â”‚                    â”‚ 10. chat()         â”‚                   â”‚
     â”‚                â”‚                    â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚                   â”‚
     â”‚                â”‚                    â”‚                   â”‚                   â”‚
     â”‚                â”‚                    â”‚                   â”‚ 11. generateContentâ”‚
     â”‚                â”‚                    â”‚                   â”‚    (Chat)         â”‚
     â”‚                â”‚                    â”‚                   â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚
     â”‚                â”‚                    â”‚                   â”‚                   â”‚
     â”‚                â”‚                    â”‚                   â”‚ 12. Return        â”‚
     â”‚                â”‚                    â”‚                   â”‚    response       â”‚
     â”‚                â”‚                    â”‚                   â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
     â”‚                â”‚                    â”‚                   â”‚                   â”‚
     â”‚                â”‚                    â”‚ 13. Parse & extractâ”‚                   â”‚
     â”‚                â”‚                    â”‚    names/places   â”‚                   â”‚
     â”‚                â”‚                    â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤                   â”‚
     â”‚                â”‚                    â”‚                   â”‚                   â”‚
     â”‚                â”‚ 14. Response       â”‚                   â”‚                   â”‚
     â”‚                â”‚    { message,      â”‚                   â”‚                   â”‚
     â”‚                â”‚      extractedInfo }â”‚                   â”‚                   â”‚
     â”‚                â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤                   â”‚                   â”‚
     â”‚                â”‚                    â”‚                   â”‚                   â”‚
     â”‚ 15. Display    â”‚                    â”‚                   â”‚                   â”‚
     â”‚     AI Message â”‚                    â”‚                   â”‚                   â”‚
     â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤                    â”‚                   â”‚                   â”‚
```

### Sequence 3: Sending a Message

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Browser â”‚    â”‚   page.tsx   â”‚    â”‚ /api/chat    â”‚    â”‚  gemini.ts   â”‚    â”‚ Gemini API  â”‚
â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
     â”‚                â”‚                    â”‚                   â”‚                   â”‚
     â”‚ 1. User types  â”‚                    â”‚                   â”‚                   â”‚
     â”‚    message     â”‚                    â”‚                   â”‚                   â”‚
     â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚                    â”‚                   â”‚                   â”‚
     â”‚                â”‚                    â”‚                   â”‚                   â”‚
     â”‚ 2. Click Send  â”‚                    â”‚                   â”‚                   â”‚
     â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚                    â”‚                   â”‚                   â”‚
     â”‚                â”‚                    â”‚                   â”‚                   â”‚
     â”‚                â”‚ 3. Add user msg    â”‚                   â”‚                   â”‚
     â”‚                â”‚    to messages[]   â”‚                   â”‚                   â”‚
     â”‚                â”‚                    â”‚                   â”‚                   â”‚
     â”‚                â”‚ 4. POST /api/chat  â”‚                   â”‚                   â”‚
     â”‚                â”‚    (with full      â”‚                   â”‚                   â”‚
     â”‚                â”‚     history)       â”‚                   â”‚                   â”‚
     â”‚                â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚                   â”‚                   â”‚
     â”‚                â”‚                    â”‚                   â”‚                   â”‚
     â”‚                â”‚                    â”‚ 5. buildConversationâ”‚                  â”‚
     â”‚                â”‚                    â”‚    Prompt()        â”‚                   â”‚
     â”‚                â”‚                    â”‚    (with history)  â”‚                   â”‚
     â”‚                â”‚                    â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚                   â”‚
     â”‚                â”‚                    â”‚                   â”‚                   â”‚
     â”‚                â”‚                    â”‚ 6. chat()         â”‚                   â”‚
     â”‚                â”‚                    â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚                   â”‚
     â”‚                â”‚                    â”‚                   â”‚                   â”‚
     â”‚                â”‚                    â”‚                   â”‚ 7. generateContentâ”‚
     â”‚                â”‚                    â”‚                   â”‚    (with context) â”‚
     â”‚                â”‚                    â”‚                   â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚
     â”‚                â”‚                    â”‚                   â”‚                   â”‚
     â”‚                â”‚                    â”‚                   â”‚ 8. Return         â”‚
     â”‚                â”‚                    â”‚                   â”‚    response       â”‚
     â”‚                â”‚                    â”‚                   â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
     â”‚                â”‚                    â”‚                   â”‚                   â”‚
     â”‚                â”‚                    â”‚ 9. Parse response  â”‚                   â”‚
     â”‚                â”‚                    â”‚    Extract info   â”‚                   â”‚
     â”‚                â”‚                    â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤                   â”‚
     â”‚                â”‚                    â”‚                   â”‚                   â”‚
     â”‚                â”‚ 10. Response       â”‚                   â”‚                   â”‚
     â”‚                â”‚     { message,     â”‚                   â”‚                   â”‚
     â”‚                â”‚       extractedInfoâ”‚                   â”‚                   â”‚
     â”‚                â”‚       suggestComplete}                  â”‚                   â”‚
     â”‚                â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤                   â”‚                   â”‚
     â”‚                â”‚                    â”‚                   â”‚                   â”‚
     â”‚                â”‚ 11. Update dossier â”‚                   â”‚                   â”‚
     â”‚                â”‚     with new info  â”‚                   â”‚                   â”‚
     â”‚                â”‚                    â”‚                   â”‚                   â”‚
     â”‚ 12. Display    â”‚                    â”‚                   â”‚                   â”‚
     â”‚     AI Responseâ”‚                    â”‚                   â”‚                   â”‚
     â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤                    â”‚                   â”‚                   â”‚
```

### Sequence 4: Naming a Face

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Browser â”‚    â”‚   page.tsx   â”‚    â”‚memory-bank.tsâ”‚    â”‚localStorage  â”‚
â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
     â”‚                â”‚                    â”‚                   â”‚
     â”‚ 1. Click       â”‚                    â”‚                   â”‚
     â”‚    "Unknown"   â”‚                    â”‚                   â”‚
     â”‚    face        â”‚                    â”‚                   â”‚
     â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚                    â”‚                   â”‚
     â”‚                â”‚                    â”‚                   â”‚
     â”‚ 2. Enter name  â”‚                    â”‚                   â”‚
     â”‚    "Roberto"   â”‚                    â”‚                   â”‚
     â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚                    â”‚                   â”‚
     â”‚                â”‚                    â”‚                   â”‚
     â”‚ 3. Click Save  â”‚                    â”‚                   â”‚
     â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚                    â”‚                   â”‚
     â”‚                â”‚                    â”‚                   â”‚
     â”‚                â”‚ 4. cropFaceThumbnailâ”‚                   â”‚
     â”‚                â”‚    (canvas)         â”‚                   â”‚
     â”‚                â”‚                    â”‚                   â”‚
     â”‚                â”‚ 5. upsertCharacter()â”‚                   â”‚
     â”‚                â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚                   â”‚
     â”‚                â”‚                    â”‚                   â”‚
     â”‚                â”‚                    â”‚ 6. Create/Update  â”‚
     â”‚                â”‚                    â”‚    Character      â”‚
     â”‚                â”‚                    â”‚    {
     â”‚                â”‚                    â”‚      id: "...",
     â”‚                â”‚                    â”‚      name: "Roberto",
     â”‚                â”‚                    â”‚      faces: [{
     â”‚                â”‚                    â”‚        descriptor: [...],
     â”‚                â”‚                    â”‚        thumbnail: "..."
     â”‚                â”‚                    â”‚      }]
     â”‚                â”‚                    â”‚    }
     â”‚                â”‚                    â”‚                   â”‚
     â”‚                â”‚                    â”‚ 7. saveMemoryBank()â”‚
     â”‚                â”‚                    â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚
     â”‚                â”‚                    â”‚                   â”‚
     â”‚                â”‚                    â”‚ 8. localStorage   â”‚
     â”‚                â”‚                    â”‚    .setItem()     â”‚
     â”‚                â”‚                    â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
     â”‚                â”‚                    â”‚                   â”‚
     â”‚                â”‚ 9. Return updated  â”‚                   â”‚
     â”‚                â”‚    memoryBank      â”‚                   â”‚
     â”‚                â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤                   â”‚
     â”‚                â”‚                    â”‚                   â”‚
     â”‚                â”‚ 10. Update UI      â”‚                   â”‚
     â”‚                â”‚     Face now shows  â”‚                   â”‚
     â”‚                â”‚     "Roberto"      â”‚                   â”‚
     â”‚                â”‚                    â”‚                   â”‚
     â”‚ 11. See updatedâ”‚                    â”‚                   â”‚
     â”‚     face label â”‚                    â”‚                   â”‚
     â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤                    â”‚                   â”‚
```

### Sequence 5: Synthesizing Story

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Browser â”‚    â”‚   page.tsx   â”‚    â”‚/api/synthesizeâ”‚    â”‚  gemini.ts   â”‚    â”‚ Gemini API  â”‚
â”‚         â”‚    â”‚              â”‚    â”‚    -story    â”‚    â”‚              â”‚    â”‚             â”‚
â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
     â”‚                â”‚                    â”‚                   â”‚                   â”‚
     â”‚ 1. Click       â”‚                    â”‚                   â”‚                   â”‚
     â”‚    "Preview    â”‚                    â”‚                   â”‚                   â”‚
     â”‚     Story"     â”‚                    â”‚                   â”‚                   â”‚
     â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚                    â”‚                   â”‚                   â”‚
     â”‚                â”‚                    â”‚                   â”‚                   â”‚
     â”‚                â”‚ 2. POST /api/      â”‚                   â”‚                   â”‚
     â”‚                â”‚    synthesize-storyâ”‚                   â”‚                   â”‚
     â”‚                â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚                   â”‚                   â”‚
     â”‚                â”‚                    â”‚                   â”‚                   â”‚
     â”‚                â”‚                    â”‚ 3. buildSynthesis  â”‚                   â”‚
     â”‚                â”‚                    â”‚    Prompt()        â”‚                   â”‚
     â”‚                â”‚                    â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚                   â”‚
     â”‚                â”‚                    â”‚                   â”‚                   â”‚
     â”‚                â”‚                    â”‚ 4. new Google     â”‚                   â”‚
     â”‚                â”‚                    â”‚    GenerativeAI() â”‚                   â”‚
     â”‚                â”‚                    â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚                   â”‚
     â”‚                â”‚                    â”‚                   â”‚                   â”‚
     â”‚                â”‚                    â”‚                   â”‚ 5. generateContent â”‚
     â”‚                â”‚                    â”‚                   â”‚    (Synthesis)    â”‚
     â”‚                â”‚                    â”‚                   â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚
     â”‚                â”‚                    â”‚                   â”‚                   â”‚
     â”‚                â”‚                    â”‚                   â”‚ 6. Return         â”‚
     â”‚                â”‚                    â”‚                   â”‚    narrative     â”‚
     â”‚                â”‚                    â”‚                   â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
     â”‚                â”‚                    â”‚                   â”‚                   â”‚
     â”‚                â”‚                    â”‚ 7. Calculate      â”‚                   â”‚
     â”‚                â”‚                    â”‚    duration       â”‚                   â”‚
     â”‚                â”‚                    â”‚    (wordCount/2.5) â”‚                   â”‚
     â”‚                â”‚                    â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤                   â”‚
     â”‚                â”‚                    â”‚                   â”‚                   â”‚
     â”‚                â”‚ 8. Response        â”‚                   â”‚                   â”‚
     â”‚                â”‚    { narrative,    â”‚                   â”‚                   â”‚
     â”‚                â”‚      wordCount,    â”‚                   â”‚                   â”‚
     â”‚                â”‚      estimatedDuration}                 â”‚                   â”‚
     â”‚                â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤                   â”‚                   â”‚
     â”‚                â”‚                    â”‚                   â”‚                   â”‚
     â”‚ 9. Display     â”‚                    â”‚                   â”‚                   â”‚
     â”‚    narrative   â”‚                    â”‚                   â”‚                   â”‚
     â”‚    preview     â”‚                    â”‚                   â”‚                   â”‚
     â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤                    â”‚                   â”‚                   â”‚
```

## ðŸ”„ Data Flow Summary

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    DATA FLOW OVERVIEW                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Photo (base64)
    â”‚
    â”œâ”€â–º Face Detection (Client)
    â”‚   â””â”€â–º DetectedFace[] â†’ Match â†’ FaceMatch[]
    â”‚
    â””â”€â–º Photo Analysis (Server â†’ Gemini)
        â””â”€â–º PhotoAnalysis JSON

PhotoAnalysis + FaceMatches
    â”‚
    â””â”€â–º Conversation Prompt
        â”‚
        â””â”€â–º Gemini Chat API
            â”‚
            â””â”€â–º AI Response
                â”‚
                â”œâ”€â–º Extract: names, places, dates
                â”‚   â””â”€â–º Update dossier
                â”‚
                â””â”€â–º Display message

Conversation History + Dossier
    â”‚
    â””â”€â–º Synthesis Prompt
        â”‚
        â””â”€â–º Gemini API
            â”‚
            â””â”€â–º Narrative (first-person story)
                â”‚
                â””â”€â–º Preview â†’ Video Generation (future)
```

## ðŸŽ¯ Key Integration Points

1. **Client â†” Server**: HTTP POST requests to `/api/*` routes
2. **Server â†” Gemini**: Direct API calls using `@google/generative-ai`
3. **Client â†” localStorage**: Direct access for memory bank
4. **Client â†” face-api.js**: Direct browser API calls (no server needed)

## ðŸ“Š Request/Response Examples

### Analyze Photo Request
```json
POST /api/analyze-photo
{
  "imageBase64": "data:image/jpeg;base64,/9j/4AAQ...",
  "mimeType": "image/jpeg"
}
```

### Analyze Photo Response
```json
{
  "analysis": {
    "people": [
      {
        "description": "Elderly man with gray hair",
        "estimatedAge": "elderly",
        "clothing": "Striped shirt",
        "expression": "smiling"
      }
    ],
    "setting": {
      "location": "Outdoor garden",
      "indoor": false,
      "details": ["Mango tree", "Wooden table"]
    },
    "era": {
      "estimatedDecade": "1980s",
      "clues": ["Clothing style", "Photo quality"]
    },
    "mood": "happy",
    "openingObservation": "I see a warm family moment...",
    "firstQuestion": "What do you remember about the smell of those mangoes?"
  }
}
```

### Chat Request
```json
POST /api/chat
{
  "photoAnalysis": { /* PhotoAnalysis object */ },
  "messages": [
    {
      "role": "assistant",
      "content": "I see Roberto here...",
      "timestamp": 1234567890
    },
    {
      "role": "user",
      "content": "That's my father",
      "timestamp": 1234567891
    }
  ],
  "userMessage": "He loved mangoes",
  "dossier": {
    "names": ["Roberto"],
    "places": ["Manila"],
    "dates": []
  }
}
```

### Chat Response
```json
{
  "message": "Roberto's love for mangoes sounds wonderful...",
  "extractedInfo": {
    "names": [],
    "places": ["Manila"],
    "dates": ["1980s"]
  },
  "suggestComplete": false
}
```
